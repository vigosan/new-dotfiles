#!/bin/bash

# This script ensures 1password-cli is installed BEFORE chezmoi tries to render
# templates that use onepasswordRead, preventing race condition

# Check if op is already available
if command -v op >/dev/null 2>&1; then
  echo "1Password CLI already installed."
  exit 0
fi

# Ensure Homebrew is installed
if ! command -v brew >/dev/null 2>&1; then
  echo "Homebrew not found. Installing Homebrew first..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add Homebrew to PATH for current session
  if [[ $(uname -m) == "arm64" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  else
    eval "$(/usr/local/bin/brew shellenv)"
  fi
fi

# Ensure Homebrew is in PATH
if [[ $(uname -m) == "arm64" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
else
  eval "$(/usr/local/bin/brew shellenv)"
fi

# Install 1Password CLI before anything else
echo "Installing 1Password CLI (required for secrets)..."
brew install --cask 1password-cli

if command -v op >/dev/null 2>&1; then
  echo "1Password CLI installed successfully!"
else
  echo "Warning: 1Password CLI installation may have failed."
  exit 1
fi
